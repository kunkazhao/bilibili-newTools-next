# 选品库排序与“固定排序”方案

日期：2026-01-31

## 目标
- 默认仍以“手动排序”（后端 `_sort_order`）为准展示。
- 拖拽或下拉排序仅影响前端当前视图，不写本地、不写后端。
- 新增“固定排序”按钮：点击后仅写回**当前分类已加载的商品顺序**。
- 搜索/筛选时禁用“固定排序”，避免对局部结果写回。

## 范围
- 页面：选品库（Archive）。
- 仅处理商品列表顺序，不改分类/方案本身逻辑。

## 非目标
- 不对“未加载分页”的商品排序写回。
- 不新增后端接口、不改变接口协议。
- 不引入本地持久化排序（localStorage 不存用户排序结果）。
- 不支持跨分类拖拽或跨方案固定排序。

## 交互规则
- 排序下拉与拖拽：只更新前端当前顺序。
- “固定排序”按钮：
  - 仅在**无搜索/筛选**时可用；搜索/筛选中置灰。
  - 搜索/筛选定义：关键词搜索 + 价格区间 + 方案筛选。
  - 点击后将**当前分类已加载 items**的顺序写回 `_sort_order`。
  - 保存中按钮显示 loading 并禁用拖拽/排序切换。
- 方案筛选场景（schemeFilterId 非空）：按钮禁用或隐藏。

## 数据与排序逻辑
- 初始加载：从后端 `_sort_order` 生成 `manualOrder`；若缺失则保持后端返回顺序。
- 拖拽/下拉改变顺序时：不修改 item 的 `_sort_order`，不写缓存。
- 固定排序时：
  - 取当前排序后的已加载 items 列表。
  - 生成新的 `_sort_order`（例如 index*10，pad 成 6 位字符串）。
  - 本地先更新 items 的 `spec._sort_order` 与 `manualOrder`，确保 UI 稳定。
  - 逐条 PATCH 写回 `/api/sourcing/items/{id}`。
  - 单条失败不回滚整体顺序，提示失败数量。

## 缓存策略
- 继续缓存 items/分类列表用于首屏加速。
- **不缓存 manualOrder**（避免本地持久化用户排序）。

## 失败与提示
- 写回失败：提示“固定排序失败 X 条”，但保留当前前端顺序。
- 中途切换分类/离开页面：取消未完成请求并提示。

## 视觉与文案
- 按钮文案：固定排序
- 禁用提示：搜索/筛选中不可固定排序

## 验证点
- 拖拽/下拉排序不触发后端写入。
- 搜索/筛选时按钮禁用。
- 点击固定排序仅写回已加载 items。
- 部分失败提示正确且不回滚前端顺序。

## 风险与规避
- 风险：未加载商品仍保持旧顺序，与已固定部分混排。
  - 规避：文案提示“仅固定当前已加载商品”。
