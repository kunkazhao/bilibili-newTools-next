# 获取佣金页置顶评论提速（并发限流）设计

## 背景
获取佣金页在“提取置顶评论链接”时会对每个视频串行调用 `getPinnedComments`，并在得到链接后串行调用 `fetchCommissionProduct`。在几十个视频的场景下，总耗时随视频数线性增长，用户感知为“一个一个跳”。

## 目标
- 显著缩短批量视频提取的总耗时（速度优先）。
- 不改动现有去重、汇总、弹窗与数据结构（尽量最小改动）。
- 保持失败可用：单个视频/商品失败不影响整体流程。

## 非目标
- 不新增后端批量接口或缓存。
- 不改变解析范围（仍提取置顶评论 + 子回复）。
- 不引入复杂队列依赖库。

## 现状问题
1) 视频解析完全串行：每个视频都会拉取详情、置顶评论、子回复分页，耗时累加。
2) 商品解析完全串行：评论内的商品链接逐条请求，耗时进一步叠加。

## 方案概述（并发限流）
在前端新增轻量并发池：
- 评论池：并发处理多个视频（建议 3–5）。
- 商品池：并发处理多个商品链接（建议 6–10）。

并发池提供统一接口：
```
runWithConcurrency(items, limit, handler, onProgress?)
```
确保并发上限固定、任务完成后更新进度。

## 关键数据流
1) `uniqueVideos` 进入评论池并发处理。
2) 每个视频完成后：
   - 提取评论中的商品链接并去重。
   - 立即把链接推入商品池（流式处理）。
3) 商品池解析商品详情，沿用现有 `dedupeMap` 与 `summary` 逻辑。

为避免并发写入状态冲突：
- 用 `useRef` 保存 `summary` / `addedItems` / `dedupeMap`。
- 任务内写 ref，流程结束后一次性 `applyExtractionResult()`。

## 进度与提示
进度 UI 仍用现有弹窗，但文案区分阶段：
- `正在获取评论 X/Y`
- `正在获取商品 A/B`

必要时对 `setProgress` 做节流（如 100ms 合并），避免并发造成过度渲染。

## 限流与错误处理
- 对 B 站限流类错误（403/412/429 或 `BiliApiError`）做 1–2 次轻量退避重试（500–1500ms 随机延迟）。
- 其他错误直接记录 `failedLinks`，不中断流程。
- 并发数常量化，必要时可快速调为 1（回退到串行）。

## 验证方式
- 手动验证：5–10 个视频样本，确认速度提升与进度显示正常。
- 错误场景：无效视频链接/请求失败时，失败统计正确且流程不中断。
- 功能回归：提取到的商品数量与旧流程一致。

## 风险与回退
主要风险为 B 站接口限流，解决办法是：
- 保守并发上限 + 轻量退避重试。
- 一键降并发到 1 作为回退。
